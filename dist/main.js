(()=>{"use strict";var t,e,s;!function(t){t[t.unsplash=0]="unsplash",t[t.bing=1]="bing",t[t.local=2]="local"}(t||(t={})),function(t){t[t.google=0]="google",t[t.bing=1]="bing"}(e||(e={})),function(t){t[t.raw=0]="raw",t[t.full=1]="full",t[t.regular=2]="regular",t[t.small=3]="small"}(s||(s={}));class i{constructor(){this.title="",this.link="",this.img=""}}class n{}var r=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{l(i.next(t))}catch(t){r(t)}}function a(t){try{l(i.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}l((i=i.apply(t,e||[])).next())}))};class o{static debounce(t,e){let s;return(...i)=>{clearTimeout(s),s=setTimeout((()=>{clearTimeout(s),t(...i)}),e)}}static isURL(t){return t.length<2083&&/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,6}(:[0-9]{1,5})?(\/.*)?$/gi.test(t)}}class a{static load(){this.textBox=document.querySelector("#textInput"),this.siteBox=document.querySelector("#sites"),this.searchBar=document.querySelector("#searchBar"),this.searchGlass=document.querySelector("#searchBar>.backglass"),this.bottomBar=document.querySelector("#bottomBar"),this.bottomGlass=document.querySelector("#bottomBar>.backglass"),this.settingIcon=document.querySelector("#settingIcon"),this.settingPanel=document.querySelector("#settingPanel"),this.settingClose=document.querySelector("#settingClose"),this.cover=document.querySelector("#cover")}static query(t){return document.querySelector(t)}static queryAll(t){return document.querySelectorAll(t)}}class l{static fetch(t,e,s){return r(this,void 0,void 0,(function*(){const e=yield this.requestImage(t,s);return this.resolveData(t,e)}))}static refresh(t){a.cover.append(t)}static writeInfo(t){a.query("#imageLink").setAttribute("href",t.url||""),a.query("#authorLink").setAttribute("href",t.link||""),a.query("#authorLink").innerText=t.author||"",a.query("#imageTitle").innerText=t.title||"",a.query("#model").innerText=t.brief||"",a.query("#location").innerText=t.location||"",a.query("#infoText").style.display="block",t.color&&(a.query("#cover").style.background=t.color,a.query("meta[name='theme-color']").setAttribute("content",t.color))}static loadImage(t,e){return new Promise(((s,i)=>{const n=document.createElement("img");n.src=this.getUrl(t,e)||"",n.addClass("coverImage"),n.addEventListener("load",(()=>{s(n)}))}))}static getUrl(t,e){switch(e){case s.raw:return t.raw;case s.full:return t.full;case s.regular:return t.regular;default:return t.small}}static requestImage(e,s){return r(this,void 0,void 0,(function*(){if(e==t.unsplash){let t=`https://api.unsplash.com/photos/random?client_id=${this.unsplashID}&orientation=landscape`;return s&&(t+="&query="+s),yield fetch(t,{mode:"cors"}).then((t=>t.json()))}if(e==t.bing){const t=`https://www.bing.com/HPImageArchive.aspx?format=js&idx=${Math.floor(7*Math.random())}&n=1`;return yield fetch(t,{mode:"cors",headers:{"X-Requested-With":""}}).then((t=>t.json()))}}))}static resolveData(e,s){return e==t.unsplash?this.resolveUnsplashData(s):e==t.bing?this.resolveBingData(s):new n}static resolveUnsplashData(t){const e=new n;let s;if(t&&t.results&&t.results.length)s=t.results[0];else{if(!t)return e;s=t}return e.raw=s.urls.raw,e.full=s.urls.full,e.regular=s.urls.regular,e.small=s.urls.small,e.title="",e.url=s.links.html,e.author="© Unsplash "+s.user.name,e.link=s.user.links.html,e.brief=s.exif.name,e.location=s.location.title,e.color=s.color,e}static resolveBingData(t){const e=new n;if(t&&t.images&&t.images.length>0){const s=t.images[0],i=/(.*?)[,|，](.*)\((.*)\)/.exec(s.copyright);e.raw="https://www.bing.com/"+s.url.replace("1920x1080","UHD"),e.full="https://www.bing.com/"+s.url.replace("1920x1080","UHD"),e.regular="https://www.bing.com/"+s.url,e.small="https://www.bing.com/"+s.url.replace("1920x1080","1366x768"),e.url=s.copyrightlink,i&&(e.title=i[1],e.location=i[2],e.author=i[3])}return e}static getIconImageList(t){return new Promise(((e,s)=>{fetch(`https://itunes.apple.com/search?term=${t}&limit=10&media=software`).then((t=>t.json())).then((t=>{t.results?e(t.results.map((t=>t.artworkUrl60))):e([])}))}))}}l.unsplashID="691b20a234f612603711b9eabd89df4729a06478f16d7e89cd8526340897b18d";class c{static initialize(){try{localStorage}catch(t){this.storageEnabled=!1,a.settingIcon.remove()}}static getItem(t){if(!this.storageEnabled)return;const e=localStorage.getItem(t);return e?JSON.parse(e):void 0}static setItem(t,e){this.storageEnabled&&localStorage.setItem(t,JSON.stringify(e))}}c.storageEnabled=!0;class u{static initialize(){try{const t=window.indexedDB.open(u.dbName,u.dbVersion);t.onupgradeneeded=t=>{var e;u.db=null===(e=t.target)||void 0===e?void 0:e.result;const s=u.db.createObjectStore("queries",{keyPath:"query"});s.createIndex("visit","visit",{unique:!1}),s.add({query:"test",visit:1})},t.onsuccess=t=>{var e;u.db=null===(e=t.target)||void 0===e?void 0:e.result,this.dbEnabled=!0}}catch(t){this.dbEnabled=!1}}static updateQuery(t){return new Promise(((e,s)=>{if(!u.dbEnabled)return e(!1);const i=u.db.transaction("queries","readwrite").objectStore("queries"),n=i.get(t);n.onsuccess=()=>{let s=1;n.result?(s=n.result.visit+1,i.put({query:t,visit:s})):i.add({query:t,visit:s}),e(!0)},n.onerror=()=>{s()}}))}static getQuery(t){return new Promise(((e,s)=>{if(!u.dbEnabled)return e({});const i=u.db.transaction("queries").objectStore("queries").openCursor(window.IDBKeyRange.bound(t,t+"￿"),"prev");i.onsuccess=t=>{var s;e(null===(s=t.target)||void 0===s?void 0:s.result)},i.onerror=()=>{s()}}))}}u.dbEnabled=!1,u.dbName="safari_homepage",u.dbVersion=2;const d={version:2,source:t.unsplash,count:10,search:e.google,history:!1,size:s.regular,keyword:"Sakura",shortcuts:[{title:"Google",link:"https://google.com",img:"icons/google.png"},{title:"Twitter",link:"https://twitter.com",img:"icons/twitter.png"},{title:"Apple",link:"https://apple.com",img:"icons/applestore.png"},{title:"Instagram",link:"https://instagram.com",img:"icons/instagram.png"},{title:"YouTube",link:"https://youtube.com",img:"icons/youtube.png"},{title:"Amazon",link:"https://amazon.co.jp",img:"icons/amazon.png"},{title:"GitHub",link:"https://github.com",img:"icons/github.png"},{title:"Google Translate",link:"https://translate.google.com",img:"icons/translate.png"}]};var g=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function o(t){try{l(i.next(t))}catch(t){r(t)}}function a(t){try{l(i.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}l((i=i.apply(t,e||[])).next())}))};HTMLElement.prototype.addClass=function(t){this.classList.contains(t)||this.classList.add(t)},HTMLElement.prototype.removeClass=function(t){this.classList.contains(t)&&this.classList.remove(t)},HTMLElement.prototype.toggleClass=function(t){this.classList.contains(t)?this.classList.remove(t):this.classList.add(t)},HTMLElement.prototype.val=function(t){return t&&(this.value=t),this.value},(new class{constructor(){this.currentConfig=d}start(){return g(this,void 0,void 0,(function*(){yield this.waitDocumentReady(),c.initialize(),u.initialize(),this.loadConfig(),a.load(),a.textBox.focus(),this.applyShortcuts(),this.addListener(),this.initialSettings(),yield this.refreshWallpaper()}))}loadConfig(){const t=c.getItem("config");t?this.currentConfig=t:c.setItem("config",this.currentConfig)}refreshWallpaper(){return g(this,void 0,void 0,(function*(){let t=c.getItem("imageinfo");if(t||(t=yield l.fetch(this.currentConfig.source,this.currentConfig.size,this.currentConfig.keyword)),t){const e=yield l.loadImage(t,this.currentConfig.size);l.refresh(e),l.writeInfo(t),window.requestAnimationFrame((()=>{e.addClass("show")}))}t=yield l.fetch(this.currentConfig.source,this.currentConfig.size,this.currentConfig.keyword),t&&((yield l.loadImage(t,this.currentConfig.size)).remove(),c.setItem("imageinfo",t))}))}addListener(){a.textBox.addEventListener("keydown",(t=>g(this,void 0,void 0,(function*(){const s=t.target,i=t.keyCode?t.keyCode:t.which;s.setAttribute("lastkey",i.toString());const n=a.query("#textInput").val();if(13==i&&n){this.currentConfig.history&&(yield u.updateQuery(n.toLocaleLowerCase()));let t="";t=o.isURL(n)?0==n.indexOf("http")?n:"http://"+n:this.currentConfig.search==e.google?`https://www.google.com/search?q=${n}`:`https://bing.com/search?q=${n}`,document.location=t}})))),a.textBox.addEventListener("input",(t=>g(this,void 0,void 0,(function*(){var e;const s=t.target;if(s){const t=(null===(e=s.val())||void 0===e?void 0:e.toLocaleLowerCase())||"";let i=s.getAttribute("suggestion")||"";if(this.currentConfig.history&&t.length>1&&t.length!==i.length&&"8"!==s.getAttribute("lastkey")){const e=yield u.getQuery(t);if(e&&e.value&&e.value.query){i=e.value.query;const n=s.val()+i.slice(t.length);s.val(n),s.setAttribute("suggestion",i),s.selectionStart=t.length,s.selectionEnd=i.length}}}a.query("#searchBar").addClass("searchBarFocused"),o.debounce((()=>{a.query("#searchBar").removeClass("searchBarFocused")}),5e3)()})))),a.bottomBar.addEventListener("mouseenter",(()=>a.siteBox.addClass("mousein"))),a.bottomBar.addEventListener("mouseleave",(()=>a.siteBox.removeClass("mousein"))),a.settingIcon.addEventListener("click",(()=>{a.settingPanel.toggleClass("show")})),a.settingClose.addEventListener("click",(()=>{a.settingPanel.removeClass("show")})),document.addEventListener("keydown",(t=>{17!=t.which&&91!=t.which||!a.siteBox.classList.contains("mousein")||a.siteBox.addClass("editing")})),document.addEventListener("keyup",(t=>{17!=t.which&&91!=t.which||a.siteBox.removeClass("editing")})),a.query(".settingButton.cancel").addEventListener("click",(()=>{a.settingPanel.removeClass("show")})),a.query(".settingButton.submit").addEventListener("click",(()=>{this.currentConfig.source=t[a.query("[data-key='source']").val()],this.currentConfig.count=parseInt(a.query("[data-key='count']").val()||""),this.currentConfig.search=e[a.query("[data-key='search']").val()],this.currentConfig.history="true"==a.query("[data-key='history']").val(),this.currentConfig.size=s[a.query("[data-key='size']").val()],this.currentConfig.keyword=a.query("[data-key='keyword']").val()||"",c.setItem("config",this.currentConfig),a.settingPanel.removeClass("show")})),a.query(".settingButton.add").addEventListener("click",(()=>{const t=new i;t.title=a.query("[data-key='shortcutTitle']").val()||"",t.link=a.query("[data-key='shortcutLink']").val()||"",t.img=a.query("[data-key='shortcutImage']").val()||"";const e=document.createElement("a");e.href=t.link,e.title=t.title,e.className="siteButton",e.innerHTML=`\n        <img src="${t.img}" class="siteIcon"><i></i>\n        <div class="siteTitle">${t.title}</div>`.trim(),this.addShortcutListener(e),e.addClass("hide"),a.siteBox.insertBefore(e,a.query(".siteButton.add")),window.requestAnimationFrame((()=>{e.removeClass("hide")})),this.currentConfig.shortcuts.push(t),c.setItem("config",this.currentConfig),a.query(".settingPanel.shortcut").removeClass("show")})),a.query(".settingButton.leave").addEventListener("click",(()=>{a.query(".settingPanel.shortcut").removeClass("show")})),a.query(".settingButton.image").addEventListener("click",(()=>g(this,void 0,void 0,(function*(){const t=a.query("[data-key='shortcutTitle']").val();if(!t||0===t.length)return;a.query(".settingButton.image").addClass("disabled");let e="";(yield l.getIconImageList(t)).forEach(((s,i)=>{i>=5||(e+=`<img src="${s}" alt="${t}">`)})),a.query(".settingItem.full.image").innerHTML=e,a.query(".settingButton.image").removeClass("disabled")})))),a.query(".settingItem.full.image").addEventListener("click",(t=>{var e;"IMG"==t.target.nodeName&&a.query("[data-key='shortcutImage']").val(null===(e=t.target.getAttribute("src"))||void 0===e?void 0:e.replace("60x60bb","256x256bb"))})),document.body.addEventListener("mousemove",(t=>{const e=a.query(".siteButton.dragging");if(e){e.style.left=t.pageX-a.siteBox.getBoundingClientRect().left-parseInt(e.getAttribute("ox")||"")+"px",e.style.top=t.pageY-a.siteBox.getBoundingClientRect().top-parseInt(e.getAttribute("oy")||"")+"px";let s=-1;a.queryAll(".siteButton:not(.hide)").forEach(((t,i)=>{t===e&&(s=i)})),a.queryAll(".siteButton:not(.add)").forEach(((t,i)=>{-1!=s&&(i<s&&t.offsetLeft>e.offsetLeft-e.offsetWidth/2?t.addClass("moveRight"):i>s&&t.offsetLeft<e.offsetLeft+e.offsetWidth/2?t.addClass("moveLeft"):(t.removeClass("moveLeft"),t.removeClass("moveRight")))}))}}));const n=new ResizeObserver((t=>{for(const e of t)if(e.target==a.bottomBar){const t=e.contentRect.width/e.contentRect.height*200,s=`url('data:image/svg+xml;utf8,<svg preserveAspectRatio="none" viewBox="0 0 ${t} 200" xmlns="http://www.w3.org/2000/svg"><path d="M 100 0 c -90 0 -100 10 -100 100 c 0 90 10 100 100 100 l ${t-200} 0 c 90 0, 100 -10, 100 -100 c 0 -90, -10 -100, -100 -100Z" fill="white"></path></svg>')`;a.bottomGlass.style.mask=s,a.bottomGlass.style.webkitMaskImage=s}else if(e.target==a.searchBar){const t=e.contentRect.width/e.contentRect.height*200,s=`url('data:image/svg+xml;utf8,<svg preserveAspectRatio="none" viewBox="0 0 ${t} 200" xmlns="http://www.w3.org/2000/svg"><path d="M 100 0 l -30 0 c -45 0 -70 25 -70 70 l 0 60 c 0 45 25 70 70 70 l 30 0 l ${t-200} 0 l 30 0 c 45 0, 70 -25, 70 -70 l 0 -60 c 0 -45, -25 -70, -70 -70Z" fill="white"></path></svg>')`;a.searchGlass.style.mask=s,a.searchGlass.style.webkitMaskImage=s}}));n.observe(a.bottomBar),n.observe(a.searchBar)}addShortcutListener(t){t.addEventListener("mousedown",(t=>{t.preventDefault();const e=t.currentTarget;e.classList.contains("add")||a.siteBox.classList.contains("editing")&&"I"!=t.target.nodeName&&(e.addClass("dragging"),e.setAttribute("ox",(t.pageX-a.siteBox.getBoundingClientRect().left).toString()),e.setAttribute("oy",(t.pageY-a.siteBox.getBoundingClientRect().top).toString()))})),t.addEventListener("mouseup",(t=>{t.preventDefault();const e=t.currentTarget;if(e.classList.contains("add"))return;if(!e.classList.contains("dragging"))return;if("I"==t.target.nodeName)return;const s=e.getBoundingClientRect().left,i=e.getBoundingClientRect().top;let n=-1;a.queryAll(".siteButton:not(.hide)").forEach(((t,s)=>{t===e&&(n=s)}));const r=a.queryAll(".siteButton.moveLeft").length-a.queryAll(".siteButton.moveRight").length,o=this.currentConfig.shortcuts[n];this.currentConfig.shortcuts.splice(n,1),this.currentConfig.shortcuts.splice(n+r,0,o),c.setItem("config",this.currentConfig),this.applyShortcuts(),a.queryAll(".siteButton:not(.hide)").forEach(((t,e)=>{e===n+r&&(t.style.transform=`translate(${s-t.getBoundingClientRect().left}px,${i-t.getBoundingClientRect().top}px)`,t.style.transition="none",window.requestAnimationFrame((()=>{t.style.removeProperty("transform"),t.style.removeProperty("transition")})))}))})),t.addEventListener("click",(t=>{var e;const s=t.currentTarget;if("I"==t.target.nodeName){let i=-1;a.queryAll(".siteButton:not(.hide)").forEach(((t,e)=>{t===s&&(i=e)})),-1!==i&&(this.currentConfig.shortcuts=this.currentConfig.shortcuts.filter(((t,e)=>e!=i)),c.setItem("config",this.currentConfig)),null===(e=t.currentTarget)||void 0===e||e.addClass("hide"),t.preventDefault()}else s.classList.contains("add")?(a.query("[data-key='shortcutTitle']").val(""),a.query("[data-key='shortcutLink']").val(""),a.query("[data-key='shortcutImage']").val(""),a.query(".settingItem.full.image").innerHTML="",a.query(".settingPanel.config").removeClass("show"),a.query(".settingPanel.shortcut").toggleClass("show"),t.preventDefault()):s.classList.contains("dragging")?t.preventDefault():a.query("#sites").classList.contains("editing")||(a.query(".siteButton").removeClass("click"),s.addClass("click"))}))}applyShortcuts(){if(this.currentConfig){let t="";this.currentConfig.shortcuts.map((e=>{const s=`\n<a href="${e.link}" title="${e.title}" class="siteButton">\n<img src="${e.img}" class="siteIcon">\n<i></i>\n<div class="siteTitle">${e.title}</div>\n</a>`;t+=s.trim()})),t+='\n<a href="#AddShortcut" title="Add Shortcut" class="siteButton add">\n<div class="siteIcon"></div>\n<div class="siteTitle">Add Shortcut</div>\n</a>'.trim(),a.siteBox.innerHTML=t,a.queryAll(".siteButton").forEach((t=>this.addShortcutListener(t)))}}waitDocumentReady(){return new Promise(((t,e)=>{if("complete"===document.readyState||"interactive"===document.readyState)t(!0);else{const e=()=>{document.removeEventListener("DOMContentLoaded",e),t(!0)};document.addEventListener("DOMContentLoaded",e)}}))}initialSettings(){a.query("[data-key='source']").val(t[this.currentConfig.source]),a.query("[data-key='count']").val(this.currentConfig.count.toString()),a.query("[data-key='search']").val(e[this.currentConfig.search]),a.query("[data-key='history']").val((this.currentConfig.history||!1).toString()),a.query("[data-key='size']").val(s[this.currentConfig.size]),a.query("[data-key='keyword']").val(this.currentConfig.keyword)}}).start()})();